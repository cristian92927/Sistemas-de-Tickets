<div class="container" *ngIf="ticket; else loading">
  <div class="header">
    <h2>Ticket #{{ ticket.id }}: {{ ticket.title }}</h2>
    <a routerLink="/tickets">Back to List</a>
  </div>

  <div *ngIf="errorMsg" class="alert error">{{ errorMsg }}</div>
  <div *ngIf="successMsg" class="alert success">{{ successMsg }}</div>

  <div class="details-grid">
    <div class="card">
      <h3>Info</h3>
      <p><strong>Client:</strong> {{ ticket.client_name }}</p>
      <p><strong>Created:</strong> {{ ticket.created_at | date:'medium' }}</p>
      <p><strong>Description:</strong></p>
      <p>{{ ticket.description }}</p>
    </div>

    <div class="card">
      <h3>Assignment</h3>
      <p>Current Agent: <strong>{{ ticket.agent_name || 'Unassigned' }}</strong></p>
      
      <form [formGroup]="assignForm" (ngSubmit)="onAssign()" class="action-form">
        <select formControlName="agentId">
          <option value="">Select Agent</option>
          <option *ngFor="let agent of agents" [value]="agent.id">{{ agent.name }}</option>
        </select>
        <button type="submit" [disabled]="assignForm.invalid || ticket.status === 'RESOLVED'">Assign</button>
      </form>
      <p class="hint" *ngIf="ticket.status === 'RESOLVED'">Cannot assign agent to closed ticket.</p>
    </div>

    <div class="card">
      <h3>Status</h3>
      <p>Current Status: 
        <span class="status-badge" [ngClass]="{
          'status-open': ticket.status === 'OPEN',
          'status-in-progress': ticket.status === 'IN_PROGRESS',
          'status-resolved': ticket.status === 'RESOLVED'
        }">{{ ticket.status }}</span>
      </p>

      <form [formGroup]="statusForm" (ngSubmit)="onUpdateStatus()" class="action-form">
        <select formControlName="status">
          <option value="OPEN">OPEN</option>
          <option value="IN_PROGRESS">IN_PROGRESS</option>
          <option value="RESOLVED">RESOLVED</option>
        </select>
        
        <div *ngIf="statusForm.get('status')?.value === 'RESOLVED'">
          <textarea formControlName="resolution" placeholder="Enter resolution details..."></textarea>
           <div *ngIf="statusForm.get('resolution')?.invalid && statusForm.get('resolution')?.touched" class="error-msg">
            Resolution is required.
          </div>
        </div>

        <button type="submit" [disabled]="statusForm.invalid">Update Status</button>
      </form>
    </div>
  
    <div class="card full-width" *ngIf="ticket.resolution">
      <h3>Resolution</h3>
      <p>{{ ticket.resolution }}</p>
    </div>
  </div>
</div>

<ng-template #loading>
  <p>Loading ticket details...</p>
</ng-template>
